generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  username    String     @unique
  password    String
  role        Role       @default(EMPLOYEE)
  employeeId  String?    @unique
  permissions Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employee    Employee?  @relation(fields: [employeeId], references: [id])
  userRoles   UserRole[]

  @@index([email])
  @@index([username])
  @@index([role])
}

// ==========================================
// RBAC (Role-Based Access Control) Models
// ==========================================

model IAMRole {
  id          String     @id @default(cuid())
  name        String     @unique // "HR_MANAGER", "FINANCE_LEAD", etc.
  displayName String              // "HR Manager", "Finance Lead"
  description String?
  isSystem    Boolean    @default(false) // true for ADMIN, MANAGER, EMPLOYEE
  permissions Json       // Array of permission codes ["employees.view", "payroll.manage"]
  color       String?    // Badge color for UI
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  users       UserRole[]

  @@index([isSystem])
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?  // Who assigned this role
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       IAMRole  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Permission {
  id          String  @id @default(cuid())
  code        String  @unique // "employees.view", "payroll.manage"
  name        String           // "View Employees"
  description String?
  module      String           // "employees", "payroll", "attendance"
  action      String           // "view", "manage", "edit", "approve"
  isSystem    Boolean @default(true)

  @@index([module])
}

model Employee {
  id                       String             @id @default(cuid())
  employeeId               String             @unique
  name                     String
  email                    String             @unique
  phone                    String
  altPhone                 String?
  address                  String
  designation              String
  salary                   Float
  variablePay              Float?
  department               String
  employeeType             String?
  salesTarget              Float?
  reportingHeadId          String?
  dateOfJoining            DateTime
  profilePicture           String?
  documents                Json?
  aadharNumber             String?
  panNumber                String?
  aadharDocument           String?
  panDocument              String?
  bankName                 String?
  bankAddress              String?
  accountNumber            String?
  ifscCode                 String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  salaryType               SalaryType         @default(FIXED)
  isActive                 Boolean            @default(true)
  altEmail                 String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  attendance               Attendance[]
  bankingDetails           BankingDetails?
  reportingHead            Employee?          @relation("ReportingStructure", fields: [reportingHeadId], references: [id])
  subordinates             Employee[]         @relation("ReportingStructure")
  employeeDocuments        EmployeeDocument[]
  leaves                   Leave[]
  messages                 Message[]
  payroll                  Payroll[]
  projects                 ProjectMember[]
  tasks                    Task[]
  user                     User?

  @@index([isActive])
}

model Attendance {
  id            String           @id @default(cuid())
  employeeId    String
  date          DateTime
  punchIn       DateTime?
  punchOut      DateTime?
  breakStart    DateTime?        // Deprecated: Use breaks relation instead. Kept for backward compatibility.
  breakEnd      DateTime?        // Deprecated: Use breaks relation instead. Kept for backward compatibility.
  grossHours    Float?           // Total hours = Punch Out - Punch In (raw time in office)
  totalHours    Float?           // Active work hours = grossHours - breakDuration - idleTime
  breakDuration Float?           // Total break duration (calculated from all breaks)
  idleTime      Float?           // Total idle time (from inactive heartbeats)
  status        AttendanceStatus @default(ABSENT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  punchInIp     String?
  punchOutIp    String?
  activityLogs  ActivityLog[]
  breaks        Break[]          // Multiple breaks per attendance
  employee      Employee         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date], name: "employeeId_date")
  @@index([employeeId])
  @@index([date])
  @@index([status])
}

model Break {
  id           String     @id @default(cuid())
  attendanceId String
  startTime    DateTime
  endTime      DateTime?
  duration     Float?     // Duration in hours (calculated when break ends)
  reason       String?    // Optional reason for break (lunch, personal, etc.)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([startTime])
}

model ActivityLog {
  id               String     @id @default(cuid())
  attendanceId     String
  timestamp        DateTime
  active           Boolean    @default(true)
  createdAt        DateTime   @default(now())
  suspicious       Boolean    @default(false)
  patternDetails   String?
  patternType      String?
  source           String?    // 'client' or 'server' - to distinguish heartbeat origin
  browserName      String?
  browserVersion   String?
  confidence       String?
  confidenceScore  Float?
  deviceType       String?
  durationMs       Int?
  ipAddress        String?
  language         String?
  osName           String?
  osVersion        String?
  patternStartTime DateTime?
  screenResolution String?
  timezone         String?
  userAgent        String?
  attendance       Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([timestamp])
  @@index([suspicious])
  @@index([confidence])
  @@index([ipAddress])
}

model Leave {
  id           String      @id @default(cuid())
  employeeId   String
  leaveType    LeaveType
  startDate    DateTime
  endDate      DateTime
  days         Int
  reason       String
  status       LeaveStatus @default(PENDING)
  adminComment String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  employee     Employee    @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

model Project {
  id              String          @id @default(cuid())
  projectId       String          @unique
  name            String
  description     String
  sowDocument     String?
  projectType     ProjectType     @default(MILESTONE)
  totalBudget     Float?
  upfrontPayment  Float?          @default(0)
  currency        String          @default("USD")
  startDate       DateTime
  endDate         DateTime?
  status          ProjectStatus   @default(ACTIVE)
  milestones      Json?
  successCriteria String?
  leadId          String?
  saleId          String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  members         ProjectMember[]
  tasks           Task[]

  @@index([status])
  @@index([startDate])
}

model ProjectMember {
  id         String   @id @default(cuid())
  projectId  String
  employeeId String
  role       String?
  createdAt  DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id])
  project    Project  @relation(fields: [projectId], references: [id])
}

model Task {
  id          String       @id @default(cuid())
  projectId   String?
  milestone   String?
  assignedTo  String
  title       String
  description String
  status      TaskStatus   @default(PENDING)
  priority    Priority     @default(MEDIUM)
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  employee    Employee     @relation(fields: [assignedTo], references: [id])
  project     Project?     @relation(fields: [projectId], references: [id])
  updates     TaskUpdate[]
}

model TaskUpdate {
  id        String   @id @default(cuid())
  taskId    String
  content   String
  createdBy String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model DailyWorkUpdate {
  id                String   @id @default(cuid())
  employeeId        String
  date              DateTime
  workCompleted     String
  obstaclesOvercome String?
  tasksLeft         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([employeeId, date], name: "employeeId_date")
  @@index([employeeId])
  @@index([date])
}

model Payroll {
  id              String        @id @default(cuid())
  employeeId      String
  month           Int
  year            Int
  workingDays     Int           @default(30)
  daysPresent     Int           @default(0)
  daysAbsent      Int           @default(0)
  basicSalary     Float
  variablePay     Float         @default(0)
  salesTarget     Float?
  targetAchieved  Float?        @default(0)
  basicPayable    Float
  variablePayable Float         @default(0)
  grossSalary     Float
  professionalTax Float         @default(200)
  tds             Float         @default(0)
  penalties       Float         @default(0)
  advancePayment  Float         @default(0)
  otherDeductions Float         @default(0)
  totalDeductions Float         @default(0)
  netSalary       Float
  status          PayrollStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  employee        Employee      @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
  @@index([status])
}

model SalaryConfig {
  id            String   @id @default(cuid())
  pfPercentage  Float    @default(12)
  esiPercentage Float    @default(0.75)
  taxSlabs      Json?
  bonusRules    Json?
  updatedAt     DateTime @updatedAt
}

model CompanyProfile {
  id           String               @id @default(cuid())
  companyName  String               @default("Infiniti Tech Partners")
  address1     String?
  address2     String?
  city         String?
  state        String?
  pincode      String?
  country      String               @default("India")
  phone        String?
  email        String?
  website      String?
  logo         String?
  panNumber    String?
  gstNumber    String?
  cinNumber    String?
  updatedAt    DateTime             @updatedAt
  bankAccounts CompanyBankAccount[]
}

model CompanyBankAccount {
  id            String         @id @default(cuid())
  companyId     String
  nickname      String
  accountType   String         @default("Indian")
  bankName      String
  accountNumber String
  accountHolder String?
  ifscCode      String?
  branchName    String?
  swiftCode     String?
  iban          String?
  routingNumber String?
  bankAddress   String?
  currency      String         @default("INR")
  isDefault     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  company       CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  clientName    String
  clientEmail   String?
  amount        Float
  currency      String        @default("INR")
  status        InvoiceStatus @default(DRAFT)
  items         Json?
  dueDate       DateTime?
  notes         String?
  skyDoSynced   Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  clientAddress String?
  fileUrl       String?
  paidAmount    Float?
  paidDate      DateTime?

  @@index([status])
  @@index([dueDate])
}

model Account {
  id              String          @id @default(cuid())
  type            AccountType
  categoryId      String
  amount          Float
  currency        String          @default("INR")
  date            DateTime
  description     String
  reference       String?
  paymentPurpose  String?
  paymentMode     String?
  senderName      String?
  bankInfo        String?
  paymentTo       String?
  paymentCategory String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  category        AccountCategory @relation(fields: [categoryId], references: [id])
}

model AccountCategory {
  id            String      @id @default(cuid())
  name          String      @unique
  type          AccountType
  subCategories Json?
  createdAt     DateTime    @default(now())
  accounts      Account[]
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  subject     String?
  content     String
  read        Boolean  @default(false)
  tracked     Boolean  @default(true)
  createdAt   DateTime @default(now())
  sender      Employee @relation(fields: [senderId], references: [id])

  @@index([senderId])
  @@index([recipientId])
  @@index([recipientId, read])
  @@index([createdAt])
}

model MessagingPermission {
  id                 String   @id @default(cuid())
  userId             String   @unique
  canMessagePeers    Boolean  @default(true)
  canMessageManager  Boolean  @default(true)
  canMessageDirector Boolean  @default(false)
  allowedRecipients  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model SalesTarget {
  id             String   @id @default(cuid())
  employeeId     String
  month          Int
  year           Int
  targetAmount   Float
  achievedAmount Float    @default(0)
  commission     Float    @default(0)
  numberOfSales  Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([employeeId, month, year])
}

model Report {
  id          String     @id @default(cuid())
  reportType  ReportType
  month       Int?
  year        Int?
  data        Json
  generatedBy String?
  createdAt   DateTime   @default(now())
}

model Lead {
  id                   String        @id @default(cuid())
  leadNumber           String        @unique
  companyName          String
  companyAddress       String?
  contactName          String
  email                String
  phone                String
  altPhone             String?
  projectType          String?
  estimatedValue       Float?
  source               String?
  executiveName        String?
  communicationDetails String?
  status               CRMLeadStatus @default(NEW)
  callbackDateTime     DateTime?
  assignedTo           String?
  notes                String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  convertedAt          DateTime?
  saleId               String?       @unique
  sale                 Sale?         @relation(fields: [saleId], references: [id])

  @@index([status])
  @@index([assignedTo])
  @@index([createdAt])
}

model Sale {
  id            String     @id @default(cuid())
  saleNumber    String     @unique
  leadId        String?    @unique
  companyName   String
  contactName   String
  email         String
  phone         String
  product       String
  quantity      Int        @default(1)
  unitPrice     Float
  grossAmount   Float
  upfrontAmount Float
  discount      Float      @default(0)
  taxPercentage Float      @default(0)
  taxAmount     Float      @default(0)
  netAmount     Float
  currency      String     @default("USD")
  status        SaleStatus @default(PENDING)
  closedBy      String?
  closedAt      DateTime?
  month         Int?
  year          Int?
  commission    Float?
  notes         String?
  accountSynced Boolean    @default(false)
  projectSynced Boolean    @default(false)
  projectId     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  lead          Lead?

  @@index([status])
  @@index([closedBy])
  @@index([month, year])
  @@index([createdAt])
}

model HRDocument {
  id          String    @id @default(cuid())
  type        HRDocType
  title       String
  description String?
  content     String?
  filePath    String?
  year        Int?
  isActive    Boolean   @default(true)
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model IntegrationConnection {
  id                 String                   @id @default(cuid())
  platform           IntegrationType
  name               String
  authType           String
  accessToken        String
  refreshToken       String?
  tokenExpiry        DateTime?
  organizationUrl    String?
  organizationName   String?
  workspaceId        String?
  syncEnabled        Boolean                  @default(true)
  syncFrequency      String                   @default("MANUAL")
  lastSyncAt         DateTime?
  lastSyncStatus     String?
  lastSyncError      String?
  isActive           Boolean                  @default(true)
  createdBy          String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  confluenceSpaceKey String?
  confluencePages    ConfluencePage[]
  commits            DeveloperCommit[]
  userMappings       IntegrationUserMapping[]
  workItems          WorkItem[]

  @@index([platform])
  @@index([isActive])
}

model IntegrationUserMapping {
  id             String                @id @default(cuid())
  connectionId   String
  employeeId     String
  employeeEmail  String
  externalUserId String
  externalEmail  String
  externalName   String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  connection     IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, employeeId])
  @@unique([connectionId, externalUserId])
  @@index([employeeId])
}

model WorkItem {
  id             String                @id @default(cuid())
  connectionId   String
  externalId     String
  externalUrl    String
  platform       IntegrationType
  title          String
  description    String?
  workItemType   String
  status         String
  priority       String?
  assignedToId   String?
  assignedTo     String?
  assignedToName String?
  createdDate    DateTime
  modifiedDate   DateTime?
  completedDate  DateTime?
  dueDate        DateTime?
  projectName    String?
  projectId      String?
  areaPath       String?
  iterationPath  String?
  storyPoints    Int?
  sectionId      String?
  sectionName    String?
  tags           Json?
  metadata       Json?
  lastSyncedAt   DateTime              @default(now())
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  parentPageId   String?
  spaceKey       String?
  spaceName      String?
  version        Int?
  commits        DeveloperCommit[]
  connection     IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([connectionId])
  @@index([assignedToId])
  @@index([platform])
  @@index([status])
  @@index([createdDate])
}

model DeveloperCommit {
  id              String                @id @default(cuid())
  connectionId    String
  employeeId      String
  commitHash      String
  commitMessage   String
  commitUrl       String?
  repositoryName  String
  repositoryId    String?
  branchName      String?
  filesChanged    Int                   @default(0)
  linesAdded      Int                   @default(0)
  linesDeleted    Int                   @default(0)
  commitDate      DateTime
  authorDate      DateTime?
  workItemId      String?
  linkedWorkItems Json?
  authorName      String
  authorEmail     String
  lastSyncedAt    DateTime              @default(now())
  createdAt       DateTime              @default(now())
  connection      IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  workItem        WorkItem?             @relation(fields: [workItemId], references: [id])

  @@unique([connectionId, commitHash])
  @@index([employeeId])
  @@index([commitDate])
  @@index([repositoryName])
}

model PullRequest {
  id             String    @id @default(cuid())
  connectionId   String
  externalId     String
  externalUrl    String
  title          String
  description    String?
  status         String
  repositoryName String
  repositoryId   String?
  sourceBranch   String
  targetBranch   String
  createdById    String?
  createdByName  String
  reviewers      Json?
  createdDate    DateTime
  closedDate     DateTime?
  mergedDate     DateTime?
  commitsCount   Int       @default(0)
  filesChanged   Int       @default(0)
  lastSyncedAt   DateTime  @default(now())
  createdAt      DateTime  @default(now())

  @@unique([connectionId, externalId])
  @@index([createdById])
  @@index([createdDate])
}

model ConfluencePage {
  id             String                @id @default(cuid())
  connectionId   String
  externalId     String
  type           String                @default("page")
  status         String                @default("current")
  title          String
  content        String
  spaceId        String?
  spaceKey       String?
  spaceName      String?
  parentId       String?
  parentType     String?
  position       Int?
  authorId       String?
  authorName     String?
  ownerId        String?
  version        Int                   @default(1)
  versionMessage String?
  metadata       Json?
  createdDate    DateTime
  updatedDate    DateTime
  lastSyncedAt   DateTime              @default(now())
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  connection     IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([connectionId])
  @@index([spaceKey])
  @@index([parentId])
  @@index([createdDate])
}

model BankingDetails {
  id                String    @id @default(cuid())
  employeeId        String    @unique
  bankName          String
  branchName        String?
  accountHolderName String
  accountNumber     String
  accountType       String?
  ifscCode          String
  swiftCode         String?
  upiId             String?
  panNumber         String?
  pfAccountNumber   String?
  esiNumber         String?
  uanNumber         String?
  isVerified        Boolean   @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

model EmployeeDocument {
  id               String       @id @default(cuid())
  employeeId       String
  documentType     DocumentType
  documentName     String
  fileName         String
  fileUrl          String
  fileSize         Int?
  mimeType         String?
  documentNumber   String?
  issuedDate       DateTime?
  expiryDate       DateTime?
  issuingAuthority String?
  isVerified       Boolean      @default(false)
  verifiedBy       String?
  verifiedAt       DateTime?
  notes            String?
  uploadedBy       String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  employee         Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([documentType])
}

model Designation {
  id           String        @id @default(cuid())
  name         String        @unique
  level        Int           @default(0)
  departmentId String?
  parentId     String?
  description  String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  department   Department?   @relation(fields: [departmentId], references: [id])
  parent       Designation?  @relation("DesignationHierarchy", fields: [parentId], references: [id])
  children     Designation[] @relation("DesignationHierarchy")

  @@index([level])
  @@index([departmentId])
  @@index([isActive])
}

model Department {
  id           String        @id @default(cuid())
  name         String        @unique
  code         String?       @unique
  description  String?
  headId       String?
  parentId     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  parent       Department?   @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children     Department[]  @relation("DepartmentHierarchy")
  designations Designation[]

  @@index([isActive])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  userName   String
  userRole   String
  action     String
  entityType String
  entityId   String
  entityName String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
}

model BrowserActivityLog {
  id               String              @id @default(cuid())
  userId           String
  userName         String
  userRole         String
  employeeId       String?
  eventType        BrowserEventType
  sessionId        String?
  tabId            String?
  browserName      String?
  browserVersion   String?
  osName           String?
  osVersion        String?
  deviceType       String?
  screenResolution String?
  timezone         String?
  language         String?
  ipAddress        String?
  userAgent        String?
  pageUrl          String?
  pagePath         String?
  duration         Int?                // Duration in seconds (for session end events)
  metadata         Json?
  createdAt        DateTime            @default(now())

  @@index([userId])
  @@index([employeeId])
  @@index([eventType])
  @@index([sessionId])
  @@index([createdAt])
}

enum BrowserEventType {
  TAB_OPENED
  TAB_CLOSED
  TAB_VISIBLE
  TAB_HIDDEN
  TAB_FOCUSED
  TAB_BLURRED
  SESSION_START
  SESSION_END
  PAGE_LOAD
  PAGE_UNLOAD
  WINDOW_MINIMIZED
  WINDOW_RESTORED
}

model Holiday {
  id          String   @id @default(cuid())
  name        String
  date        DateTime
  year        Int
  isOptional  Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([year])
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
  WEEKEND
}

enum LeaveType {
  SICK
  CASUAL
  EARNED
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  HOLD
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  HOLD
  COMPLETED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum AccountType {
  INCOME
  EXPENSE
}

enum CRMLeadStatus {
  NEW
  COLD_CALL_BACK
  WARM
  PROSPECT
  SALE_MADE
  HOLD
  DORMANT
  CONVERTED
  LOST
}

enum ProjectType {
  MILESTONE
  RETAINER
}

enum ReportType {
  APR
  DSR
  PERFORMANCE
  SALES
  ACCOUNTS
}

enum SaleStatus {
  PENDING
  CONFIRMED
  DELIVERED
  PAID
  CANCELLED
}

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
}

enum HRDocType {
  POLICY
  HOLIDAY_LIST
  COMPANY_HIERARCHY
  OTHER
}

enum IntegrationType {
  AZURE_DEVOPS
  ASANA
  CONFLUENCE
}

enum DocumentType {
  AADHAR_CARD
  PAN_CARD
  PASSPORT
  DRIVING_LICENSE
  VOTER_ID
  TENTH_MARKSHEET
  TWELFTH_MARKSHEET
  GRADUATION_DEGREE
  POST_GRADUATION_DEGREE
  OTHER_CERTIFICATE
  OFFER_LETTER
  APPOINTMENT_LETTER
  EXPERIENCE_LETTER
  RELIEVING_LETTER
  SALARY_SLIP
  FORM_16
  BANK_STATEMENT
  CANCELLED_CHEQUE
  ADDRESS_PROOF
  PROFILE_PHOTO
  RESUME
  OTHER
}

enum SalaryType {
  FIXED
  VARIABLE
}

// ==========================================
// AI/ML MODELS
// ==========================================

// AI Document Processing
model AIDocumentExtraction {
  id            String   @id @default(cuid())
  documentId    String?
  documentType  String
  fileName      String
  filePath      String?
  extractedData Json
  entities      Json?
  confidence    Float
  processingTime Int?
  status        AIProcessingStatus @default(PENDING)
  error         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([documentType])
  @@index([status])
  @@index([createdAt])
}

// AI Predictions (Attrition, Performance, etc.)
model AIPrediction {
  id            String   @id @default(cuid())
  employeeId    String
  predictionType PredictionType
  riskScore     Float
  riskLevel     String
  factors       Json
  recommendations Json?
  confidence    Float
  validFrom     DateTime @default(now())
  validUntil    DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@index([employeeId])
  @@index([predictionType])
  @@index([riskLevel])
  @@index([isActive])
}

// AI Chat Sessions
model AIChatSession {
  id          String   @id @default(cuid())
  userId      String
  employeeId  String?
  context     Json?
  status      ChatSessionStatus @default(ACTIVE)
  messageCount Int     @default(0)
  lastMessageAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  messages    AIChatMessage[]

  @@index([userId])
  @@index([employeeId])
  @@index([status])
}

// AI Chat Messages
model AIChatMessage {
  id          String   @id @default(cuid())
  sessionId   String
  role        ChatRole
  content     String
  metadata    Json?
  intent      String?
  action      Json?
  tokens      Int?
  createdAt   DateTime @default(now())
  session     AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([role])
  @@index([createdAt])
}

// Sentiment Analysis Results
model AISentimentAnalysis {
  id          String   @id @default(cuid())
  sourceType  SentimentSourceType
  sourceId    String
  text        String
  sentiment   String
  score       Float
  confidence  Float
  aspects     Json?
  emotions    Json?
  createdAt   DateTime @default(now())

  @@index([sourceType])
  @@index([sourceId])
  @@index([sentiment])
  @@index([createdAt])
}

// Resume Parsing Results
model AIResumeAnalysis {
  id            String   @id @default(cuid())
  candidateId   String?
  fileName      String
  filePath      String?
  parsedData    Json
  skills        Json
  experience    Json
  education     Json
  overallScore  Float?
  matchScores   Json?
  biasFlags     Json?
  status        AIProcessingStatus @default(PENDING)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([candidateId])
  @@index([status])
}

// Skill Gap Analysis
model AISkillGap {
  id            String   @id @default(cuid())
  employeeId    String
  currentRole   String
  targetRole    String?
  gaps          Json
  overallScore  Float
  learningPath  Json?
  priority      String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([employeeId])
  @@index([isActive])
}

// AI Automation Rules
model AIAutomationRule {
  id          String   @id @default(cuid())
  name        String
  type        AutomationType
  conditions  Json
  actions     Json
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  triggerCount Int     @default(0)
  lastTriggered DateTime?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  logs        AIAutomationLog[]

  @@index([type])
  @@index([isActive])
}

// AI Automation Logs
model AIAutomationLog {
  id          String   @id @default(cuid())
  ruleId      String
  entityType  String
  entityId    String
  action      String
  result      String
  details     Json?
  createdAt   DateTime @default(now())
  rule        AIAutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([entityType])
  @@index([createdAt])
}

// Anomaly Detection
model AIAnomaly {
  id          String   @id @default(cuid())
  type        String
  severity    String
  entityType  String
  entityId    String
  description String
  data        Json
  status      AnomalyStatus @default(OPEN)
  reviewedBy  String?
  reviewedAt  DateTime?
  resolution  String?
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([entityType])
  @@index([status])
  @@index([createdAt])
}

// AI Generated Insights
model AIInsight {
  id          String   @id @default(cuid())
  type        InsightType
  category    String
  title       String
  description String
  data        Json
  importance  Float
  actionable  Boolean  @default(false)
  actions     Json?
  dismissed   Boolean  @default(false)
  dismissedBy String?
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([category])
  @@index([importance])
  @@index([dismissed])
  @@index([createdAt])
}

// Natural Language Queries
model AINLQuery {
  id            String   @id @default(cuid())
  userId        String
  originalQuery String
  parsedIntent  String?
  generatedSQL  String?
  result        Json?
  executionTime Int?
  success       Boolean  @default(false)
  error         String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([success])
  @@index([createdAt])
}

// Learning Recommendations
model AILearningRecommendation {
  id            String   @id @default(cuid())
  employeeId    String
  courseId      String?
  courseName    String
  provider      String?
  skillsCovered Json
  reason        String
  priority      Int      @default(0)
  status        LearningStatus @default(RECOMMENDED)
  completedAt   DateTime?
  feedback      String?
  rating        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([priority])
}

// Mentor Matching
model AIMentorMatch {
  id            String   @id @default(cuid())
  mentorId      String
  menteeId      String
  matchScore    Float
  matchReasons  Json
  topics        Json?
  status        MentorMatchStatus @default(SUGGESTED)
  acceptedAt    DateTime?
  completedAt   DateTime?
  feedback      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([mentorId, menteeId])
  @@index([mentorId])
  @@index([menteeId])
  @@index([status])
}

// AI Enums
enum AIProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PredictionType {
  ATTRITION
  PERFORMANCE
  WORKLOAD
  ENGAGEMENT
}

enum ChatSessionStatus {
  ACTIVE
  CLOSED
  EXPIRED
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum SentimentSourceType {
  FEEDBACK
  SURVEY
  MESSAGE
  REVIEW
  COMMENT
}

enum AutomationType {
  LEAVE_APPROVAL
  EXPENSE_APPROVAL
  ATTENDANCE_ALERT
  PERFORMANCE_ALERT
  COMPLIANCE_CHECK
}

enum AnomalyStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum InsightType {
  ANOMALY
  TREND
  PATTERN
  CORRELATION
  THRESHOLD
  COMPARISON
  FORECAST
}

enum LearningStatus {
  RECOMMENDED
  ENROLLED
  IN_PROGRESS
  COMPLETED
  DROPPED
}

enum MentorMatchStatus {
  SUGGESTED
  ACCEPTED
  ACTIVE
  COMPLETED
  REJECTED
}

// ==========================================
// ACCOUNTING SYSTEM MODELS
// ==========================================
// Integrated from standalone accounting project
// Models use Acct prefix where they conflict with existing HRMS models

// ============================================
// CURRENCY & EXCHANGE RATES
// ============================================

model Currency {
  id            String   @id @default(cuid())
  code          String   @unique // ISO 4217 code (USD, INR, EUR)
  name          String
  symbol        String
  decimalPlaces Int      @default(2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  exchangeRatesFrom ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo   ExchangeRate[] @relation("ToCurrency")
  vouchers          Voucher[]
  acctInvoices      AcctInvoice[]
  bills             Bill[]

  @@map("currencies")
}

model ExchangeRate {
  id             String   @id @default(cuid())
  fromCurrencyId String
  toCurrencyId   String
  rate           Decimal  @db.Decimal(18, 8)
  effectiveDate  DateTime
  source         String?
  createdAt      DateTime @default(now())

  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  @@unique([fromCurrencyId, toCurrencyId, effectiveDate])
  @@map("exchange_rates")
}

// ============================================
// FISCAL YEAR & PERIODS
// ============================================

model FiscalYear {
  id        String    @id @default(cuid())
  name      String    @unique // "2024-25"
  startDate DateTime
  endDate   DateTime
  isClosed  Boolean   @default(false)
  closedAt  DateTime?
  closedBy  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  periods  FiscalPeriod[]
  vouchers Voucher[]
  budgets  AcctBudget[]

  @@map("fiscal_years")
}

model FiscalPeriod {
  id           String   @id @default(cuid())
  fiscalYearId String
  name         String   // "April 2024", "Q1 2024-25"
  periodType   String   // MONTH, QUARTER
  startDate    DateTime
  endDate      DateTime
  isClosed     Boolean  @default(false)
  closedAt     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  fiscalYear FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  @@map("fiscal_periods")
}

// ============================================
// CHART OF ACCOUNTS (LEDGERS)
// ============================================

model LedgerGroup {
  id                 String   @id @default(cuid())
  parentId           String?
  name               String   @unique
  nature             String   // ASSETS, LIABILITIES, INCOME, EXPENSES, EQUITY
  affectsGrossProfit Boolean  @default(false)
  isSystem           Boolean  @default(false)
  sequence           Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  parent   LedgerGroup?  @relation("LedgerGroupHierarchy", fields: [parentId], references: [id])
  children LedgerGroup[] @relation("LedgerGroupHierarchy")
  ledgers  Ledger[]

  @@map("ledger_groups")
}

model Ledger {
  id                  String   @id @default(cuid())
  groupId             String
  partyId             String?
  bankAccountId       String?
  name                String   @unique
  code                String?
  openingBalance      Decimal  @default(0) @db.Decimal(18, 4)
  openingBalanceType  String?  // DR or CR
  currentBalance      Decimal  @default(0) @db.Decimal(18, 4)
  creditLimit         Decimal? @db.Decimal(18, 4)
  creditDays          Int?
  gstRegistrationType String?
  gstNo               String?
  panNo               String?
  tdsApplicable       Boolean  @default(false)
  tdsRate             Decimal? @db.Decimal(5, 2)
  isBillwise          Boolean  @default(false)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  group          LedgerGroup      @relation(fields: [groupId], references: [id])
  party          Party?           @relation(fields: [partyId], references: [id])
  bankAccount    AcctBankAccount? @relation(fields: [bankAccountId], references: [id])
  voucherEntries VoucherEntry[]
  budgetLines    BudgetLine[]

  @@index([groupId])
  @@map("ledgers")
}

// ============================================
// VOUCHERS & JOURNAL ENTRIES
// ============================================

model VoucherType {
  id                 String   @id @default(cuid())
  name               String
  code               String   @unique
  nature             String   // PAYMENT, RECEIPT, CONTRA, JOURNAL, SALES, PURCHASE, DEBIT_NOTE, CREDIT_NOTE
  numberingPrefix    String?
  numberingFormat    String?
  autoNumbering      Boolean  @default(true)
  requiresApproval   Boolean  @default(false)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  vouchers Voucher[]

  @@map("voucher_types")
}

model Voucher {
  id             String    @id @default(cuid())
  fiscalYearId   String
  currencyId     String?
  voucherTypeId  String
  voucherNumber  String
  date           DateTime
  referenceNo    String?
  narration      String?
  exchangeRate   Decimal   @default(1) @db.Decimal(18, 8)
  totalDebit     Decimal   @db.Decimal(18, 4)
  totalCredit    Decimal   @db.Decimal(18, 4)
  status         String    @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, REJECTED, CANCELLED
  isPosted       Boolean   @default(false)
  postedAt       DateTime?
  createdById    String?
  approvedById   String?
  approvedAt     DateTime?
  attachments    Json?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  fiscalYear      FiscalYear       @relation(fields: [fiscalYearId], references: [id])
  currency        Currency?        @relation(fields: [currencyId], references: [id])
  voucherType     VoucherType      @relation(fields: [voucherTypeId], references: [id])
  entries         VoucherEntry[]
  invoicePayments InvoicePayment[]

  @@unique([voucherTypeId, voucherNumber, fiscalYearId])
  @@index([date])
  @@index([status])
  @@map("vouchers")
}

model VoucherEntry {
  id           String   @id @default(cuid())
  voucherId    String
  ledgerId     String
  costCenterId String?
  debitAmount  Decimal  @default(0) @db.Decimal(18, 4)
  creditAmount Decimal  @default(0) @db.Decimal(18, 4)
  narration    String?
  billRef      String?
  dueDate      DateTime?
  sequence     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  voucher    Voucher         @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  ledger     Ledger          @relation(fields: [ledgerId], references: [id])
  costCenter AcctCostCenter? @relation(fields: [costCenterId], references: [id])

  @@index([voucherId])
  @@index([ledgerId])
  @@map("voucher_entries")
}

// ============================================
// COST CENTERS (Accounting)
// ============================================

model AcctCostCenter {
  id        String   @id @default(cuid())
  parentId  String?
  name      String   @unique
  code      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent         AcctCostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children       AcctCostCenter[] @relation("CostCenterHierarchy")
  voucherEntries VoucherEntry[]

  @@map("acct_cost_centers")
}

// ============================================
// PARTIES (CUSTOMERS & VENDORS)
// ============================================

model Party {
  id                  String   @id @default(cuid())
  type                String   // CUSTOMER, VENDOR, BOTH
  name                String   @unique
  code                String?
  contactPerson       String?
  email               String?
  phone               String?
  mobile              String?
  website             String?
  billingAddress      String?
  billingCity         String?
  billingState        String?
  billingCountry      String?
  billingPostal       String?
  shippingAddress     String?
  shippingCity        String?
  shippingState       String?
  shippingCountry     String?
  shippingPostal      String?
  gstNo               String?
  panNo               String?
  gstRegistrationType String?
  creditLimit         Decimal? @db.Decimal(18, 4)
  creditDays          Int?
  paymentTerms        String?
  bankName            String?
  bankBranch          String?
  bankAccountNo       String?
  bankIfsc            String?
  openingBalance      Decimal  @default(0) @db.Decimal(18, 4)
  openingBalanceType  String?  // DR or CR
  currentBalance      Decimal  @default(0) @db.Decimal(18, 4)
  notes               String?
  tags                String[]
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  ledgers        Ledger[]
  salesOrders    SalesOrder[]
  purchaseOrders PurchaseOrder[]
  quotations     Quotation[]
  acctInvoices   AcctInvoice[]
  bills          Bill[]
  acctReceipts   AcctReceipt[]
  acctPayments   AcctPayment[]

  @@index([type])
  @@map("parties")
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model ItemCategory {
  id          String   @id @default(cuid())
  parentId    String?
  name        String   @unique
  description String?
  hsnCode     String?
  sacCode     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent   ItemCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ItemCategory[] @relation("CategoryHierarchy")
  items    Item[]

  @@map("item_categories")
}

model Item {
  id              String   @id @default(cuid())
  categoryId      String?
  name            String   @unique
  sku             String?  @unique
  barcode         String?
  description     String?
  type            String   @default("GOODS") // GOODS, SERVICES
  hsnCode         String?
  sacCode         String?
  primaryUnitId   String
  purchasePrice   Decimal? @db.Decimal(18, 4)
  sellingPrice    Decimal? @db.Decimal(18, 4)
  mrp             Decimal? @db.Decimal(18, 4)
  minStock        Decimal? @db.Decimal(18, 4)
  maxStock        Decimal? @db.Decimal(18, 4)
  reorderLevel    Decimal? @db.Decimal(18, 4)
  reorderQty      Decimal? @db.Decimal(18, 4)
  valuationMethod String   @default("WEIGHTED_AVG") // FIFO, LIFO, WEIGHTED_AVG
  trackBatch      Boolean  @default(false)
  trackSerial     Boolean  @default(false)
  trackExpiry     Boolean  @default(false)
  purchaseTaxId   String?
  salesTaxId      String?
  images          Json?
  specifications  Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category           ItemCategory?       @relation(fields: [categoryId], references: [id])
  primaryUnit        UnitOfMeasure       @relation(fields: [primaryUnitId], references: [id])
  purchaseTax        TaxConfig?          @relation("ItemPurchaseTax", fields: [purchaseTaxId], references: [id])
  salesTax           TaxConfig?          @relation("ItemSalesTax", fields: [salesTaxId], references: [id])
  alternateUnits     ItemUnit[]
  stocks             Stock[]
  batches            Batch[]
  stockMovements     StockMovement[]
  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  quotationItems     QuotationItem[]
  acctInvoiceItems   AcctInvoiceItem[]
  billItems          BillItem[]

  @@index([categoryId])
  @@map("items")
}

model UnitOfMeasure {
  id            String   @id @default(cuid())
  name          String   @unique
  symbol        String
  decimalPlaces Int      @default(2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items          Item[]
  itemUnits      ItemUnit[]
  stockMovements StockMovement[]

  @@map("units_of_measure")
}

model ItemUnit {
  id               String   @id @default(cuid())
  itemId           String
  unitId           String
  conversionFactor Decimal  @db.Decimal(18, 6)
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  item Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  unit UnitOfMeasure @relation(fields: [unitId], references: [id])

  @@unique([itemId, unitId])
  @@map("item_units")
}

model Warehouse {
  id             String   @id @default(cuid())
  name           String   @unique
  code           String?
  address        String?
  city           String?
  state          String?
  country        String?
  postalCode     String?
  contactPerson  String?
  phone          String?
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  stocks             Stock[]
  batches            Batch[]
  stockMovementsFrom StockMovement[] @relation("MovementFromWarehouse")
  stockMovementsTo   StockMovement[] @relation("MovementToWarehouse")

  @@map("warehouses")
}

model Stock {
  id                String   @id @default(cuid())
  itemId            String
  warehouseId       String
  quantity          Decimal  @db.Decimal(18, 4)
  reservedQty       Decimal  @default(0) @db.Decimal(18, 4)
  avgCost           Decimal  @default(0) @db.Decimal(18, 4)
  lastPurchasePrice Decimal? @db.Decimal(18, 4)
  lastSalePrice     Decimal? @db.Decimal(18, 4)
  updatedAt         DateTime @updatedAt

  item      Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([itemId, warehouseId])
  @@map("stocks")
}

model Batch {
  id                String    @id @default(cuid())
  itemId            String
  warehouseId       String
  batchNumber       String
  serialNumber      String?
  manufacturingDate DateTime?
  expiryDate        DateTime?
  quantity          Decimal   @db.Decimal(18, 4)
  costPrice         Decimal   @db.Decimal(18, 4)
  sellingPrice      Decimal?  @db.Decimal(18, 4)
  status            String    @default("ACTIVE") // ACTIVE, EXPIRED, CONSUMED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  item           Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  stockMovements StockMovement[]

  @@unique([itemId, warehouseId, batchNumber])
  @@map("batches")
}

model StockMovement {
  id              String   @id @default(cuid())
  itemId          String
  fromWarehouseId String?
  toWarehouseId   String?
  batchId         String?
  unitId          String
  movementType    String   // PURCHASE, SALE, TRANSFER, ADJUSTMENT, RETURN, GRN, ISSUE
  quantity        Decimal  @db.Decimal(18, 4)
  rate            Decimal  @db.Decimal(18, 4)
  totalValue      Decimal  @db.Decimal(18, 4)
  referenceType   String?  // INVOICE, BILL, TRANSFER, ADJUSTMENT
  referenceId     String?
  narration       String?
  date            DateTime
  createdAt       DateTime @default(now())

  item          Item           @relation(fields: [itemId], references: [id])
  fromWarehouse Warehouse?     @relation("MovementFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse?     @relation("MovementToWarehouse", fields: [toWarehouseId], references: [id])
  batch         Batch?         @relation(fields: [batchId], references: [id])
  unit          UnitOfMeasure  @relation(fields: [unitId], references: [id])

  @@index([itemId, date])
  @@index([referenceType, referenceId])
  @@map("stock_movements")
}

// ============================================
// SALES ORDERS & QUOTATIONS
// ============================================

model SalesOrder {
  id              String    @id @default(cuid())
  partyId         String
  orderNumber     String    @unique
  date            DateTime
  expectedDate    DateTime?
  referenceNo     String?
  status          String    @default("DRAFT") // DRAFT, CONFIRMED, PARTIAL, FULFILLED, CANCELLED
  billingAddress  String?
  shippingAddress String?
  subtotal        Decimal   @db.Decimal(18, 4)
  discountAmount  Decimal   @default(0) @db.Decimal(18, 4)
  taxAmount       Decimal   @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal   @db.Decimal(18, 4)
  notes           String?
  terms           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  party        Party            @relation(fields: [partyId], references: [id])
  items        SalesOrderItem[]
  acctInvoices AcctInvoice[]

  @@index([date])
  @@map("sales_orders")
}

model SalesOrderItem {
  id              String   @id @default(cuid())
  salesOrderId    String
  itemId          String
  description     String?
  quantity        Decimal  @db.Decimal(18, 4)
  deliveredQty    Decimal  @default(0) @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxId           String?
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  sequence        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [id])
  tax        TaxConfig? @relation(fields: [taxId], references: [id])

  @@map("sales_order_items")
}

model Quotation {
  id              String   @id @default(cuid())
  partyId         String
  quotationNumber String   @unique
  date            DateTime
  validUntil      DateTime
  referenceNo     String?
  status          String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED, EXPIRED, CONVERTED
  billingAddress  String?
  shippingAddress String?
  subtotal        Decimal  @db.Decimal(18, 4)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  notes           String?
  terms           String?
  convertedToOrder String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  party Party           @relation(fields: [partyId], references: [id])
  items QuotationItem[]

  @@index([date])
  @@map("quotations")
}

model QuotationItem {
  id              String   @id @default(cuid())
  quotationId     String
  itemId          String
  description     String?
  quantity        Decimal  @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxId           String?
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  sequence        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  quotation Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  item      Item       @relation(fields: [itemId], references: [id])
  tax       TaxConfig? @relation(fields: [taxId], references: [id])

  @@map("quotation_items")
}

// ============================================
// PURCHASE ORDERS
// ============================================

model PurchaseOrder {
  id              String    @id @default(cuid())
  partyId         String
  orderNumber     String    @unique
  date            DateTime
  expectedDate    DateTime?
  referenceNo     String?
  status          String    @default("DRAFT") // DRAFT, SENT, CONFIRMED, PARTIAL, RECEIVED, CANCELLED
  billingAddress  String?
  shippingAddress String?
  subtotal        Decimal   @db.Decimal(18, 4)
  discountAmount  Decimal   @default(0) @db.Decimal(18, 4)
  taxAmount       Decimal   @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal   @db.Decimal(18, 4)
  notes           String?
  terms           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  party Party               @relation(fields: [partyId], references: [id])
  items PurchaseOrderItem[]
  bills Bill[]

  @@index([date])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  itemId          String
  description     String?
  quantity        Decimal  @db.Decimal(18, 4)
  receivedQty     Decimal  @default(0) @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxId           String?
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  sequence        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])
  tax           TaxConfig?    @relation(fields: [taxId], references: [id])

  @@map("purchase_order_items")
}

// ============================================
// SALES INVOICES (AcctInvoice to avoid conflict)
// ============================================

model AcctInvoice {
  id              String    @id @default(cuid())
  partyId         String
  salesOrderId    String?
  currencyId      String?
  invoiceNumber   String    @unique
  date            DateTime
  dueDate         DateTime
  type            String    @default("INVOICE") // INVOICE, CREDIT_NOTE, DEBIT_NOTE, PROFORMA
  status          String    @default("DRAFT") // DRAFT, SENT, PARTIAL, PAID, OVERDUE, CANCELLED
  billingAddress  String?
  shippingAddress String?
  subtotal        Decimal   @db.Decimal(18, 4)
  discountAmount  Decimal   @default(0) @db.Decimal(18, 4)
  taxAmount       Decimal   @default(0) @db.Decimal(18, 4)
  roundOff        Decimal   @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal   @db.Decimal(18, 4)
  amountPaid      Decimal   @default(0) @db.Decimal(18, 4)
  amountDue       Decimal   @db.Decimal(18, 4)
  exchangeRate    Decimal   @default(1) @db.Decimal(18, 8)
  notes           String?
  terms           String?
  irnNumber       String?
  qrCode          String?
  eInvoiceStatus  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  party        Party             @relation(fields: [partyId], references: [id])
  salesOrder   SalesOrder?       @relation(fields: [salesOrderId], references: [id])
  currency     Currency?         @relation(fields: [currencyId], references: [id])
  items        AcctInvoiceItem[]
  taxes        AcctInvoiceTax[]
  payments     InvoicePayment[]
  acctReceipts AcctReceipt[]

  @@index([date])
  @@index([status])
  @@map("acct_invoices")
}

model AcctInvoiceItem {
  id              String   @id @default(cuid())
  invoiceId       String
  itemId          String?
  description     String
  hsnCode         String?
  quantity        Decimal  @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxableAmount   Decimal  @db.Decimal(18, 4)
  taxId           String?
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  sequence        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  invoice AcctInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  item    Item?       @relation(fields: [itemId], references: [id])
  tax     TaxConfig?  @relation(fields: [taxId], references: [id])

  @@map("acct_invoice_items")
}

model AcctInvoiceTax {
  id            String   @id @default(cuid())
  invoiceId     String
  taxId         String
  taxableAmount Decimal  @db.Decimal(18, 4)
  taxAmount     Decimal  @db.Decimal(18, 4)
  createdAt     DateTime @default(now())

  invoice AcctInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tax     TaxConfig   @relation(fields: [taxId], references: [id])

  @@map("acct_invoice_taxes")
}

// ============================================
// PURCHASE BILLS
// ============================================

model Bill {
  id              String   @id @default(cuid())
  partyId         String
  purchaseOrderId String?
  currencyId      String?
  billNumber      String   @unique
  vendorBillNo    String?
  date            DateTime
  dueDate         DateTime
  type            String   @default("BILL") // BILL, DEBIT_NOTE, CREDIT_NOTE
  status          String   @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, PARTIAL, PAID, OVERDUE, CANCELLED
  subtotal        Decimal  @db.Decimal(18, 4)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  tdsAmount       Decimal  @default(0) @db.Decimal(18, 4)
  roundOff        Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  amountPaid      Decimal  @default(0) @db.Decimal(18, 4)
  amountDue       Decimal  @db.Decimal(18, 4)
  exchangeRate    Decimal  @default(1) @db.Decimal(18, 8)
  notes           String?
  attachments     Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  party         Party          @relation(fields: [partyId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  currency      Currency?      @relation(fields: [currencyId], references: [id])
  items         BillItem[]
  taxes         BillTax[]
  acctPayments  AcctPayment[]

  @@index([date])
  @@map("bills")
}

model BillItem {
  id              String   @id @default(cuid())
  billId          String
  itemId          String?
  description     String
  hsnCode         String?
  quantity        Decimal  @db.Decimal(18, 4)
  unitPrice       Decimal  @db.Decimal(18, 4)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(18, 4)
  taxableAmount   Decimal  @db.Decimal(18, 4)
  taxId           String?
  taxAmount       Decimal  @default(0) @db.Decimal(18, 4)
  totalAmount     Decimal  @db.Decimal(18, 4)
  sequence        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bill Bill       @relation(fields: [billId], references: [id], onDelete: Cascade)
  item Item?      @relation(fields: [itemId], references: [id])
  tax  TaxConfig? @relation(fields: [taxId], references: [id])

  @@map("bill_items")
}

model BillTax {
  id            String   @id @default(cuid())
  billId        String
  taxId         String
  taxableAmount Decimal  @db.Decimal(18, 4)
  taxAmount     Decimal  @db.Decimal(18, 4)
  createdAt     DateTime @default(now())

  bill Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  tax  TaxConfig @relation(fields: [taxId], references: [id])

  @@map("bill_taxes")
}

// ============================================
// PAYMENTS & RECEIPTS (Accounting)
// ============================================

model AcctReceipt {
  id             String    @id @default(cuid())
  partyId        String
  invoiceId      String?
  receiptNumber  String    @unique
  date           DateTime
  amount         Decimal   @db.Decimal(18, 4)
  paymentMode    String    // CASH, BANK_TRANSFER, CHEQUE, UPI, CARD
  bankAccountId  String?
  chequeNo       String?
  chequeDate     DateTime?
  transactionRef String?
  notes          String?
  status         String    @default("COMPLETED") // PENDING, COMPLETED, BOUNCED, CANCELLED
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  party       Party            @relation(fields: [partyId], references: [id])
  invoice     AcctInvoice?     @relation(fields: [invoiceId], references: [id])
  bankAccount AcctBankAccount? @relation(fields: [bankAccountId], references: [id])

  @@map("acct_receipts")
}

model AcctPayment {
  id             String    @id @default(cuid())
  partyId        String
  billId         String?
  paymentNumber  String    @unique
  date           DateTime
  amount         Decimal   @db.Decimal(18, 4)
  paymentMode    String    // CASH, BANK_TRANSFER, CHEQUE, NEFT, RTGS, UPI
  bankAccountId  String?
  chequeNo       String?
  chequeDate     DateTime?
  transactionRef String?
  notes          String?
  status         String    @default("COMPLETED") // PENDING, COMPLETED, FAILED, CANCELLED
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  party       Party            @relation(fields: [partyId], references: [id])
  bill        Bill?            @relation(fields: [billId], references: [id])
  bankAccount AcctBankAccount? @relation(fields: [bankAccountId], references: [id])

  @@map("acct_payments")
}

model InvoicePayment {
  id        String   @id @default(cuid())
  invoiceId String?
  billId    String?
  voucherId String
  amount    Decimal  @db.Decimal(18, 4)
  date      DateTime
  createdAt DateTime @default(now())

  invoice AcctInvoice? @relation(fields: [invoiceId], references: [id])
  voucher Voucher      @relation(fields: [voucherId], references: [id])

  @@map("invoice_payments")
}

// ============================================
// BANKING (Accounting)
// ============================================

model AcctBankAccount {
  id             String   @id @default(cuid())
  name           String   @unique
  bankName       String
  branch         String?
  accountNumber  String   @unique
  ifscCode       String?
  swiftCode      String?
  accountType    String   // CURRENT, SAVINGS, CC, OD
  openingBalance Decimal  @default(0) @db.Decimal(18, 4)
  currentBalance Decimal  @default(0) @db.Decimal(18, 4)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ledgers          Ledger[]
  acctReceipts     AcctReceipt[]
  acctPayments     AcctPayment[]
  bankTransactions BankTransaction[]
  reconciliations  BankReconciliation[]

  @@map("acct_bank_accounts")
}

model BankTransaction {
  id               String    @id @default(cuid())
  bankAccountId    String
  date             DateTime
  description      String?
  referenceNo      String?
  debitAmount      Decimal   @default(0) @db.Decimal(18, 4)
  creditAmount     Decimal   @default(0) @db.Decimal(18, 4)
  balance          Decimal   @db.Decimal(18, 4)
  category         String?
  isReconciled     Boolean   @default(false)
  reconciledAt     DateTime?
  matchedVoucherId String?
  importSource     String?   // MANUAL, BANK_FEED, CSV
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  bankAccount AcctBankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId, date])
  @@map("bank_transactions")
}

model BankReconciliation {
  id               String    @id @default(cuid())
  bankAccountId    String
  periodStart      DateTime
  periodEnd        DateTime
  statementBalance Decimal   @db.Decimal(18, 4)
  bookBalance      Decimal   @db.Decimal(18, 4)
  difference       Decimal   @db.Decimal(18, 4)
  status           String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  completedAt      DateTime?
  completedBy      String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  bankAccount AcctBankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@map("bank_reconciliations")
}

// ============================================
// TAXATION
// ============================================

model TaxConfig {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique // GST5, GST12, GST18, VAT, TDS194C
  taxType     String   // GST, IGST, CGST, SGST, VAT, TDS, TCS, CESS
  rate        Decimal  @db.Decimal(5, 2)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  quotationItems     QuotationItem[]
  acctInvoiceItems   AcctInvoiceItem[]
  acctInvoiceTaxes   AcctInvoiceTax[]
  billItems          BillItem[]
  billTaxes          BillTax[]
  itemsPurchaseTax   Item[]             @relation("ItemPurchaseTax")
  itemsSalesTax      Item[]             @relation("ItemSalesTax")

  @@map("tax_configs")
}

model GSTReturn {
  id                String    @id @default(cuid())
  returnType        String    // GSTR1, GSTR3B, GSTR9
  period            String    // "Apr-2024", "Q1-2024"
  filingDate        DateTime?
  dueDate           DateTime
  status            String    @default("PENDING") // PENDING, FILED, REVISED
  totalTaxLiability Decimal?  @db.Decimal(18, 4)
  totalItcClaimed   Decimal?  @db.Decimal(18, 4)
  netPayable        Decimal?  @db.Decimal(18, 4)
  arn               String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("gst_returns")
}

// ============================================
// BUDGETS (Accounting)
// ============================================

model AcctBudget {
  id           String   @id @default(cuid())
  fiscalYearId String
  name         String
  description  String?
  status       String   @default("DRAFT") // DRAFT, ACTIVE, CLOSED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  fiscalYear FiscalYear   @relation(fields: [fiscalYearId], references: [id])
  lines      BudgetLine[]

  @@unique([fiscalYearId, name])
  @@map("acct_budgets")
}

model BudgetLine {
  id        String   @id @default(cuid())
  budgetId  String
  ledgerId  String
  month1    Decimal  @default(0) @db.Decimal(18, 4)
  month2    Decimal  @default(0) @db.Decimal(18, 4)
  month3    Decimal  @default(0) @db.Decimal(18, 4)
  month4    Decimal  @default(0) @db.Decimal(18, 4)
  month5    Decimal  @default(0) @db.Decimal(18, 4)
  month6    Decimal  @default(0) @db.Decimal(18, 4)
  month7    Decimal  @default(0) @db.Decimal(18, 4)
  month8    Decimal  @default(0) @db.Decimal(18, 4)
  month9    Decimal  @default(0) @db.Decimal(18, 4)
  month10   Decimal  @default(0) @db.Decimal(18, 4)
  month11   Decimal  @default(0) @db.Decimal(18, 4)
  month12   Decimal  @default(0) @db.Decimal(18, 4)
  annual    Decimal  @default(0) @db.Decimal(18, 4)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  budget AcctBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  ledger Ledger     @relation(fields: [ledgerId], references: [id])

  @@unique([budgetId, ledgerId])
  @@map("budget_lines")
}

// ============================================
// REPORT TEMPLATES
// ============================================

model ReportTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String   // BALANCE_SHEET, PROFIT_LOSS, CASH_FLOW, TRIAL_BALANCE, CUSTOM
  config    Json
  schedule  Json?
  isSystem  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("report_templates")
}

// ============================================
// ACCOUNTING ENUMS
// ============================================

enum LedgerNature {
  ASSETS
  LIABILITIES
  INCOME
  EXPENSES
  EQUITY
}

enum VoucherStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  CANCELLED
}

enum PartyType {
  CUSTOMER
  VENDOR
  BOTH
}

enum ItemType {
  GOODS
  SERVICES
}

enum ValuationMethod {
  FIFO
  LIFO
  WEIGHTED_AVG
}

enum MovementType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
  RETURN
  GRN
  ISSUE
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  PARTIAL
  FULFILLED
  RECEIVED
  CANCELLED
}

enum AcctInvoiceType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
  PROFORMA
}

enum AcctInvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum BillType {
  BILL
  DEBIT_NOTE
  CREDIT_NOTE
}

enum PaymentMode {
  CASH
  BANK_TRANSFER
  CHEQUE
  NEFT
  RTGS
  UPI
  CARD
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  BOUNCED
  CANCELLED
}

enum BankAccountType {
  CURRENT
  SAVINGS
  CC
  OD
}

enum ReconciliationStatus {
  IN_PROGRESS
  COMPLETED
}

enum TaxType {
  GST
  IGST
  CGST
  SGST
  VAT
  TDS
  TCS
  CESS
}

enum GSTReturnType {
  GSTR1
  GSTR3B
  GSTR9
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  CLOSED
}
